
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>升级CDH到5.7.0 | wzktravel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="最近对CDH进行升级，从5.4.8升级到5.7.0，主要想升级spark和hbase。">
<meta property="og:type" content="article">
<meta property="og:title" content="升级CDH到5.7.0">
<meta property="og:url" content="http://wzktravel.github.io/2016/05/24/2016-05-24-upgrade-cdh-to-5-7-0/index.html">
<meta property="og:site_name" content="wzktravel">
<meta property="og:description" content="最近对CDH进行升级，从5.4.8升级到5.7.0，主要想升级spark和hbase。">
<meta property="og:updated_time" content="2016-07-14T03:16:31.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="升级CDH到5.7.0">
<meta name="twitter:description" content="最近对CDH进行升级，从5.4.8升级到5.7.0，主要想升级spark和hbase。">
  
    <link rel="alternative" href="/atom.xml" title="wzktravel" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
  <link href="//fonts.useso.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
</head>
<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">wzktravel</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="Search">
          <input type="submit" value="" class="search-form-submit">
          <input name=tn type=hidden value="bds">
          <input name=cl type=hidden value="3">
          <input name=ct type=hidden value="2097152">
          <input type="hidden" name="si" value="wzktravel.github.io">
        </form>
      </div>
    </div>
  </div>
</header>
    <div class="outer">
      <section id="main"><article id="post-2016-05-24-upgrade-cdh-to-5-7-0" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/05/24/2016-05-24-upgrade-cdh-to-5-7-0/" class="article-date">
  <time datetime="2016-05-24T10:08:23.000Z" itemprop="datePublished">2016-05-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      升级CDH到5.7.0
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近对CDH进行升级，从5.4.8升级到5.7.0，主要想升级spark和hbase。<br><a id="more"></a></p>
<h2 id="What’s-New-In-CDH-5-7-x"><a href="#What’s-New-In-CDH-5-7-x" class="headerlink" title="What’s New In CDH 5.7.x"></a>What’s New In CDH 5.7.x</h2><p>详细信息参考<a href="http://www.cloudera.com/documentation/enterprise/release-notes/topics/cdh_rn_new_in_cdh_57.html" target="_blank" rel="external">What’s New In CDH 5.7.x</a></p>
<ol>
<li>操作系统支持 RHEL/CentOS 6.6, 6.7, 7.1, 7.2 </li>
<li>JDK版本必须1.7或以上。</li>
<li>Spark升级到1.6.0，支持hive on spark</li>
<li>各服务版本:</li>
</ol>
<table>
<thead>
<tr>
<th>Component</th>
<th>Package Version</th>
</tr>
</thead>
<tbody>
<tr>
<td>Apache Hadoop</td>
<td>hadoop-2.6.0+cdh5.7.0+1280</td>
</tr>
<tr>
<td>HBase</td>
<td>hbase-1.2.0+cdh5.7.0+129</td>
</tr>
<tr>
<td>Apache Hive</td>
<td>hive-1.1.0+cdh5.7.0+522</td>
</tr>
<tr>
<td>Hue</td>
<td>hue-3.9.0+cdh5.7.0+1759</td>
</tr>
<tr>
<td>Apache Impala</td>
<td>impala-2.5.0+cdh5.7.0+0</td>
</tr>
<tr>
<td>Apache Oozie</td>
<td>oozie-4.1.0+cdh5.7.0+267</td>
</tr>
<tr>
<td>Apache Sentry</td>
<td>sentry-1.5.1+cdh5.7.0+184</td>
</tr>
<tr>
<td>Apache Spark</td>
<td>spark-1.6.0+cdh5.7.0+180</td>
</tr>
<tr>
<td>Apache Sqoop</td>
<td>sqoop-1.4.6+cdh5.7.0+56</td>
</tr>
<tr>
<td>Apache Sqoop2</td>
<td>sqoop2-1.99.5+cdh5.7.0+38</td>
</tr>
<tr>
<td>Zookeeper</td>
<td>zookeeper-3.4.5+cdh5.7.0+94</td>
</tr>
</tbody>
</table>
<p>更多服务的版本和下载地址参考: <a href="http://www.cloudera.com/documentation/enterprise/release-notes/topics/cdh_vd_cdh_package_tarball_57.html" target="_blank" rel="external">CDH 5.7.x Packaging and Tarball Information</a></p>
<h2 id="CDH升级"><a href="#CDH升级" class="headerlink" title="CDH升级"></a>CDH升级</h2><h3 id="数据库备份"><a href="#数据库备份" class="headerlink" title="数据库备份"></a>数据库备份</h3><h4 id="cloudera-manager数据备份"><a href="#cloudera-manager数据备份" class="headerlink" title="cloudera manager数据备份"></a>cloudera manager数据备份</h4><p>cloudera manager使用postgres来存储，数据库信息可以在/etc/cloudera-scm-server/db.properties中找到。</p>
<p>备份命令:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pg_dump -p 7432 -U scm &gt; /data/backup/scm_server_db_backup.$(date +%Y%m%d)</div></pre></td></tr></table></figure>
<h4 id="服务数据备份"><a href="#服务数据备份" class="headerlink" title="服务数据备份"></a>服务数据备份</h4><p>使用的是mysql，涉及的库有<code>hive</code>, <code>hue</code>, <code>sentry</code>, <code>oozie</code>, <code>sqoop</code></p>
<ul>
<li><code>mysqldump -h vlnx107010 -uroot -p hive &gt; /data/backup/hive-backup.$(date +%Y%m%d).sql</code></li>
<li><code>mysqldump -h vlnx107010 -uroot -p hue &gt; /data/backup/hue-backup.$(date +%Y%m%d).sql</code></li>
<li><code>mysqldump -h vlnx107010 -uroot -p sentry &gt; /data/backup/sentry-backup.$(date +%Y%m%d).sql</code></li>
<li><code>mysqldump -h vlnx107010 -uroot -p oozie_oozie_server &gt; /data/backup/oozie-backup.$(date +%Y%m%d).sql</code></li>
<li><code>mysqldump -h vlnx107010 -uroot -p sqoop &gt; /data/backup/sqoop-backup.$(date +%Y%m%d).sql</code></li>
</ul>
<h3 id="更新cloudera-manager-server"><a href="#更新cloudera-manager-server" class="headerlink" title="更新cloudera manager server"></a>更新cloudera manager server</h3><p>使用packages方式更新。</p>
<h4 id="停止cloudera-manager-server-database-agent"><a href="#停止cloudera-manager-server-database-agent" class="headerlink" title="停止cloudera manager server, database, agent"></a>停止cloudera manager server, database, agent</h4><ol>
<li>停止正在运行的命令</li>
<li><p>停止cloudera-manager服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo service cloudera-scm-server stop</div></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>使用内嵌的PostgreSQL数据库的话，停止此服务</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo service cloudera-scm-server-db stop</div></pre></td></tr></table></figure>
<blockquote>
<p>==<strong>Important:</strong>== If you are not running the embedded database service and you attempt to stop it, you receive a message indicating that the service cannot be found. If instead you get a message that the shutdown failed, the embedded database is still running, probably because services are connected to the Hive metastore. If the database shutdown fails due to connected services, issue the following command:<br> RHEL-compatible 7 and higher:</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ sudo service cloudera-scm-server-db next_stop_fast</div><div class="line">$ sudo service cloudera-scm-server-db stop</div><div class="line">``` </div><div class="line">All other Linux distributions:</div><div class="line">&gt;</div></pre></td></tr></table></figure>
</blockquote>
<p> sudo service cloudera-scm-server-db fast_stop</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">    </div><div class="line">4. 停止cloudera-agent服务</div><div class="line"></div><div class="line">   ``` bash</div><div class="line">   $ sudo service cloudera-scm-agent stop</div></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="设置repo"><a href="#设置repo" class="headerlink" title="设置repo"></a>设置repo</h4><h5 id="在线升级，使用cloudera源"><a href="#在线升级，使用cloudera源" class="headerlink" title="在线升级，使用cloudera源"></a>在线升级，使用cloudera源</h5><p>如果网络速度比较快，可以直接新建<code>cloudera-manager.repo</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[cloudera-manager]</div><div class="line"># Packages for Cloudera Manager, Version 5, on RHEL or CentOS 6 x86_64</div><div class="line">name = Cloudera Manager</div><div class="line">baseurl = https://archive.cloudera.com/cm5/redhat/6/x86_64/cm/5/</div><div class="line">gpgkey = https://archive.cloudera.com/cm5/redhat/6/x86_64/cm/RPM-GPG-KEY-cloudera </div><div class="line">gpgcheck = 1</div></pre></td></tr></table></figure>
<h5 id="搭建本地源"><a href="#搭建本地源" class="headerlink" title="搭建本地源"></a>搭建本地源</h5><p>如果访问cloudera源不太稳定，可以搭建本地的repo源。</p>
<ol>
<li><p>安装vsftp</p>
<p>使用vsftp作为ftp服务器，配置文件在<code>/etc/vsftpd/</code>下，ftp路径在<code>/var/ftp/</code>下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ yum install vsftpd</div><div class="line">$ service vsftpd start</div></pre></td></tr></table></figure>
</li>
<li><p>下载rpm包和repodata</p>
<p>新建目录<code>/var/ftp/pub/cloudera-repo</code>作为repo源目录，从<code>https://archive.cloudera.com/cm5/redhat/6/x86_64/cm/5/</code>按下载所需的rpm包和repodata目录，完成后目录结构如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">$ tree /var/ftp/pub/cloudera-repo/</div><div class="line">/var/ftp/pub/cloudera-repo/</div><div class="line">├── repodata</div><div class="line">│   ├── filelists.xml.gz</div><div class="line">│   ├── filelists.xml.gz.asc</div><div class="line">│   ├── other.xml.gz</div><div class="line">│   ├── other.xml.gz.asc</div><div class="line">│   ├── primary.xml.gz</div><div class="line">│   ├── primary.xml.gz.asc</div><div class="line">│   ├── repomd.xml</div><div class="line">│   └── repomd.xml.asc</div><div class="line">└── RPMS</div><div class="line">    └── x86_64</div><div class="line">        ├── cloudera-manager-agent-5.7.0-1.cm570.p0.76.el6.x86_64.rpm</div><div class="line">        ├── cloudera-manager-daemons-5.7.0-1.cm570.p0.76.el6.x86_64.rpm</div><div class="line">        ├── cloudera-manager-server-5.7.0-1.cm570.p0.76.el6.x86_64.rpm</div><div class="line">        └── cloudera-manager-server-db-2-5.7.0-1.cm570.p0.76.el6.x86_64.rpm</div></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>新建本地repo<code>cloudera-manager.repo</code>如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[cloudera-manager]</div><div class="line">name = Cloudera Manager, Version 5.7.0</div><div class="line">baseurl = ftp://$&#123;local-repo-ip&#125;/pub/cloudera-repo</div><div class="line">gpgcheck = 0</div></pre></td></tr></table></figure>
<ul>
<li>如果手动升级各机器的cloudera-manager-agent，需要将cloudera-manager.repo更新到所有节点上</li>
<li>如果使用cloudera升级各机器的cloudera-manager-agent，在升级时注意选择<strong><code>Custom Repository</code></strong>，填写repository地址为<code>ftp://${local-repo-ip}/pub/cloudera-repo</code>。</li>
</ul>
</li>
</ol>
<h4 id="进行升级"><a href="#进行升级" class="headerlink" title="进行升级"></a>进行升级</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ sudo yum clean all</div><div class="line">$ sudo yum upgrade cloudera-manager-server cloudera-manager-daemons cloudera-manager-server-db-2 cloudera-manager-agent</div></pre></td></tr></table></figure>
<h4 id="重启cloudera-manager服务"><a href="#重启cloudera-manager服务" class="headerlink" title="重启cloudera manager服务"></a>重启cloudera manager服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ sudo service cloudera-scm-server-db start</div><div class="line">$ sudo service cloudera-scm-server start</div></pre></td></tr></table></figure>
<h3 id="更新cloudera-manager-agent"><a href="#更新cloudera-manager-agent" class="headerlink" title="更新cloudera manager agent"></a>更新cloudera manager agent</h3><blockquote>
<p>==<strong>Important:</strong>== All hosts in the cluster must have access to the Internet if you plan to use archive.cloudera.com as the source for installation files. If you do not have Internet access, create a custom repository.</p>
</blockquote>
<p>以下两种升级任选一种。</p>
<h4 id="使用cloudera进行升级"><a href="#使用cloudera进行升级" class="headerlink" title="使用cloudera进行升级"></a>使用cloudera进行升级</h4><p>进入cloudera manager后，会自动弹出升级页面，选择<code>Yes, I would like to upgrade the Cloudera Manager Agent packages now</code>，然后一步步进行。</p>
<p>在选择Cloudera Manager Agent Release时，有两种选择</p>
<ol>
<li>如果进行在线升级，选择<code>Matched Release for this Cloudera Manager Server</code>，这样会直接从<code>https://archive.cloudera.com/cm5/redhat/6/x86_64/cm/5/</code>进行更新。</li>
<li>如果自己下载了rpm包，并建立了本地repo源，选择<code>Custom Repository</code>，然后填写本地repo源地址。</li>
</ol>
<p>这两种方式都会在每台机器<code>/etc/yum.repos.d/</code>目录下生成<code>cloudera-manager.repo</code>，不过其中的<code>baseurl</code>参数不同。</p>
<h4 id="手动进行更新"><a href="#手动进行更新" class="headerlink" title="手动进行更新"></a>手动进行更新</h4><ol>
<li>在每台机器上添加<code>cloudera-manager.repo</code>并清理yum cache，<code>yum clean all</code>。</li>
<li>停止cloudera-scm-agent服务: <code>service cloudera-scm-agent stop</code>。</li>
<li>更新cloudera-manager-agent: <code>yum upgrade cloudera-manager-server cloudera-manager-daemons cloudera-manager-server-db-2 cloudera-manager-agent</code>。</li>
<li>启动cloudera-scm-agent服务: <code>service cloudera-scm-agent start</code>。</li>
</ol>
<h3 id="验证CDH升级是否成功"><a href="#验证CDH升级是否成功" class="headerlink" title="验证CDH升级是否成功"></a>验证CDH升级是否成功</h3><p>在页面上<code>hosts</code>页面，点击<code>Inspect All Hosts</code>，检测完成后可以查看结果，能够比较详细的查看各机器情况。</p>
<h2 id="服务升级"><a href="#服务升级" class="headerlink" title="服务升级"></a>服务升级</h2><p>CDH升级后，更要重的是对CDH管理的服务进行升级，这里使用parcels进行升级。</p>
<h3 id="创建临时远程仓库"><a href="#创建临时远程仓库" class="headerlink" title="创建临时远程仓库"></a>创建临时远程仓库</h3><ol>
<li>新建目录<code>/data/cloudera-parcel-server</code></li>
<li><p>下载CDH parcel和manifest.json</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ wget http://archive.cloudera.com/cdh5/parcels/5/CDH-5.7.0-1.cdh5.7.0.p0.45-el6.parcel</div><div class="line">$ wget http://archive.cloudera.com/cdh5/parcels/5/manifest.json</div></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>下载kafka parcel和manifest.json</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ wget http://archive.cloudera.com/kafka/parcels/2/KAFKA-2.0.1-1.2.0.1.p0.5-el6.parcel</div><div class="line">$ wget http://archive.cloudera.com/kafka/parcels/2/manifest.json</div></pre></td></tr></table></figure>
</li>
<li><p>下载gplextras5和manifest.json</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ wget http://archive.cloudera.com/gplextras5/parcels/5/GPLEXTRAS-5.6.1-1.cdh5.6.1.p0.5-el6.parcel</div><div class="line">$ wget http://archive.cloudera.com/gplextras5/parcels/5/manifest.json</div></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>整体目录结构如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$ tree /data/cloudera-parcel-server/</div><div class="line"> /data/cloudera-parcel-server/</div><div class="line"> ├── cdh</div><div class="line"> │   ├── CDH-5.7.0-1.cdh5.7.0.p0.45-el6.parcel</div><div class="line"> │   └── manifest.json</div><div class="line"> ├── gplextras</div><div class="line"> │   ├── GPLEXTRAS-5.6.1-1.cdh5.6.1.p0.5-el6.parcel</div><div class="line"> │   └── manifest.json</div><div class="line"> └── kafka</div><div class="line">     ├── KAFKA-2.0.1-1.2.0.1.p0.5-el6.parcel</div><div class="line">     └── manifest.json</div><div class="line"></div><div class="line"> 3 directories, 6 files</div></pre></td></tr></table></figure>
</li>
<li><p>启动一个server</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ python -m SimpleHTTPServer 8080</div></pre></td></tr></table></figure>
</li>
</ol>
<p>   在浏览器中打开链接查看是否启动成功，<code>http://{http-server-ip}:8080</code>，成功后可以在parcels的配置<code>Remote Parcel Repository URLs</code>中添加相关的parcel地址:</p>
<ul>
<li><code>http://{http-server-ip}:8080/cdh/</code></li>
<li><code>http://{http-server-ip}:8080/kafka/</code></li>
<li><code>http://{http-server-ip}:8080/gplextras/</code></li>
</ul>
<h3 id="CDH-Parcel-服务-升级"><a href="#CDH-Parcel-服务-升级" class="headerlink" title="CDH Parcel(服务)升级"></a>CDH Parcel(服务)升级</h3><p>参考<a href="http://www.cloudera.com/documentation/enterprise/latest/topics/install_upgrade_to_cdh57_parcels.html" target="_blank" rel="external">Upgrading to CDH 5.7 Using Parcels</a></p>
<ol>
<li>在<code>Hosts -&gt; Parcels</code>处设置上一个步骤中的parcel临时远程仓库</li>
<li>在首页cluster名右侧小三角处点击『Upgrade Cluster』，仔细阅读升级前的准备，并提前准备好</li>
<li>在节点检测完后，选择<code>Let me upgrade the cluster</code>，手动进行重启服务以避免服务不可用。</li>
<li>升级Oozie ShareLib，在Oozie服务页面，点击<code>Actions &gt; Install Oozie ShareLib</code>。</li>
<li>升级Sqoop2，在Sqoop2页面，点击<code>Actions &gt; Upgrade Sqoop</code>。</li>
<li>升级Spark，在spark页面，点击<code>Actions &gt; Install Spark JAR</code>和<code>Actions &gt; Create Spark History Log Dir</code>。</li>
<li>手动将服务一个个重启，可以在每个服务的<code>Instances</code>Tab页，一个实例一个实例的重启，这样可以避免服务不可用。</li>
<li>重启完后，运行<code>Deploy Client Configuration</code>。</li>
<li>在parcels页面可以删除之前的parcel。</li>
</ol>
<p>另外的途径可以在<code>Hosts &gt; parcels</code>页面手动进行<code>Distribute</code>和<code>Active</code>，然后进行上面的步骤4–步骤9。</p>
<h3 id="KAFKA-Parcel升级"><a href="#KAFKA-Parcel升级" class="headerlink" title="KAFKA Parcel升级"></a>KAFKA Parcel升级</h3><p>在<code>Hosts &gt; parcels</code>页面手动对Kafka Parcel进行<code>Distribute</code>和<code>Active</code>，然后对Kafka Broker一台台进行重启，确定没问题后可以删除旧的parcel。</p>
<h3 id="GPLEXTRAS-Parcel升级-添加对lzo的支持"><a href="#GPLEXTRAS-Parcel升级-添加对lzo的支持" class="headerlink" title="GPLEXTRAS Parcel升级(添加对lzo的支持)"></a>GPLEXTRAS Parcel升级(添加对lzo的支持)</h3><p>参考<a href="http://www.cloudera.com/documentation/enterprise/latest/topics/cm_mc_gpl_extras.html" target="_blank" rel="external">Configuring Services to Use the GPL Extras Parcel</a></p>
<ol>
<li>在<code>Hosts &gt; parcels</code>页面手动对gplextras parcel进行<code>Distribute</code>和<code>Active</code></li>
<li>HDFS服务中修改配置<code>Compression Codecs</code>，添加<code>com.hadoop.compression.lzo.LzoCodec</code>和<code>com.hadoop.compression.lzo.LzopCodec</code>，重启HDFS。</li>
<li>在每台Oozie Server上建立hadoop-lzo.jar的软链接，<code>ln -sf /opt/cloudera/parcels/GPLEXTRAS/lib/hadoop/lib/hadoop-lzo.jar /var/lib/ooziehadoop-lzo.jar</code>，重启Oozie。</li>
<li>Sqoop2服务中修改配置<code>Sqoop Service Environment Advanced Configuration Snippet</code>，添加<code>HADOOP_CLASSPATH=$HADOOP_CLASSPATH:/opt/cloudera/parcels/GPLEXTRAS/lib/hadoop/lib/*</code>和<code>JAVA_LIBRARY_PATH=$JAVA_LIBRARY_PATH:/opt/cloudera/parcels/GPLEXTRAS/lib/hadoop/lib/native</code>，重启Sqoop2。</li>
<li>重启其他需要重启的服务。</li>
<li>运行<code>Deploy Client Configuration</code>。</li>
</ol>
<h3 id="CDH-Client-Gateway-升级"><a href="#CDH-Client-Gateway-升级" class="headerlink" title="CDH Client(Gateway)升级"></a>CDH Client(Gateway)升级</h3><p>在升级后，发现各Client中的命令引用没有更新，需要手动将<code>/etc/alternatives/</code>目录下CDH相关更新为最新。<br>以<code>spark-shell</code>为例。</p>
<ol>
<li>执行<code>which spark-shell</code>，发现指向<code>/usr/bin/spark-shell</code></li>
<li>执行<code>ls -l /usr/bin/spark-shell</code>，发现是个软链接并指向了<code>/etc/alternatives/spark-shell</code></li>
<li>执行<code>ls -l /etc/alternatives/spark-shell</code>，发现是个软链接并指向了<code>/opt/cloudera/parcels/CDH-5.4.8-1.cdh5.4.8.p0.4/bin/spark-shell</code>，明显还指向升级前的版本。</li>
<li>执行<code>ln -sf /opt/cloudera/parcels/CDH/bin/spark-shell /etc/alternatives/spark-shell</code>将其指向最新的版本。</li>
</ol>
<p>可以使用shell脚本批量将<code>/etc/alternatives</code>下CDH相关软链接指向最新的版本。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li>Upgrading Cloudera Manager 5 to the Latest Cloudera Manager: <a href="http://www.cloudera.com/documentation/enterprise/latest/topics/cm_ag_upgrade_cm5.html" target="_blank" rel="external">http://www.cloudera.com/documentation/enterprise/latest/topics/cm_ag_upgrade_cm5.html</a></li>
<li>Upgrading CDH and Managed Services Using Cloudera Manager: <a href="http://www.cloudera.com/documentation/enterprise/latest/topics/cm_mc_upgrading_cdh.html" target="_blank" rel="external">http://www.cloudera.com/documentation/enterprise/latest/topics/cm_mc_upgrading_cdh.html</a></li>
<li>Upgrading to CDH 5.7 Using Parcels: <a href="http://www.cloudera.com/documentation/enterprise/latest/topics/install_upgrade_to_cdh57_parcels.html" target="_blank" rel="external">http://www.cloudera.com/documentation/enterprise/latest/topics/install_upgrade_to_cdh57_parcels.html</a></li>
<li>Creating a Temporary Remote Repository: <a href="http://www.cloudera.com/documentation/enterprise/latest/topics/cm_ig_create_local_parcel_repo.html" target="_blank" rel="external">http://www.cloudera.com/documentation/enterprise/latest/topics/cm_ig_create_local_parcel_repo.html</a></li>
<li>postgresql常用命令: <a href="http://blog.chinaunix.net/uid-26642180-id-3485465.html" target="_blank" rel="external">http://blog.chinaunix.net/uid-26642180-id-3485465.html</a></li>
<li>Running Hive on Spark: <a href="http://www.cloudera.com/documentation/enterprise/latest/topics/admin_hos_oview.html" target="_blank" rel="external">http://www.cloudera.com/documentation/enterprise/latest/topics/admin_hos_oview.html</a></li>
<li>Configuring Services to Use the GPL Extras Parcel: <a href="http://www.cloudera.com/documentation/enterprise/latest/topics/cm_mc_gpl_extras.html" target="_blank" rel="external">http://www.cloudera.com/documentation/enterprise/latest/topics/cm_mc_gpl_extras.html</a></li>
<li>CDH 5.7.0 Properties: <a href="http://www.cloudera.com/documentation/enterprise/latest/topics/cm_props_cdh570.html" target="_blank" rel="external">http://www.cloudera.com/documentation/enterprise/latest/topics/cm_props_cdh570.html</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://wzktravel.github.io/2016/05/24/2016-05-24-upgrade-cdh-to-5-7-0/" data-id="ciqlv6twq001xpo9kw3bmorgd" class="article-share-link">分享到</a>
      

      
        <a href="http://wzktravel.github.io/2016/05/24/2016-05-24-upgrade-cdh-to-5-7-0/#ds-thread" class="article-comment-link">评论</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cdh/">cdh</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cloudera/">cloudera</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hadoop/">hadoop</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hive/">hive</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/spark/">spark</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2016/05/11/2016-05-11-elasticsearch-reindex/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">elasticsearch修改mapping重建索引</div>
    </a>
  
</nav>

  
</article>


  <section id="comments">
    <div id="ds-thread" class="ds-thread" data-thread-key="2016/05/24/2016-05-24-upgrade-cdh-to-5-7-0/" data-title="升级CDH到5.7.0" data-url="http://wzktravel.github.io/2016/05/24/2016-05-24-upgrade-cdh-to-5-7-0/"></div>
  </section>
</section>
      
      <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CDH/">CDH</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/awk/">awk</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/azkaban/">azkaban</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cdh/">cdh</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cloudera/">cloudera</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/elasticsearch/">elasticsearch</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flume/">flume</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github/">github</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hadoop/">hadoop</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hdfs/">hdfs</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hive/">hive</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jvm/">jvm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kafka/">kafka</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kerberos/">kerberos</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lambda/">lambda</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/log/">log</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lzo/">lzo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mac/">mac</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ntp/">ntp</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/quartz/">quartz</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/queue/">queue</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scala/">scala</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sed/">sed</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sentry/">sentry</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell/">shell</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spark/">spark</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sql/">sql</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vim/">vim</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/yarn/">yarn</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/任务调度/">任务调度</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/多线程/">多线程</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/调度/">调度</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/CDH/" style="font-size: 15px;">CDH</a> <a href="/tags/awk/" style="font-size: 10px;">awk</a> <a href="/tags/azkaban/" style="font-size: 10px;">azkaban</a> <a href="/tags/cdh/" style="font-size: 11.67px;">cdh</a> <a href="/tags/cloudera/" style="font-size: 11.67px;">cloudera</a> <a href="/tags/elasticsearch/" style="font-size: 10px;">elasticsearch</a> <a href="/tags/flume/" style="font-size: 11.67px;">flume</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/github/" style="font-size: 11.67px;">github</a> <a href="/tags/hadoop/" style="font-size: 20px;">hadoop</a> <a href="/tags/hdfs/" style="font-size: 13.33px;">hdfs</a> <a href="/tags/hive/" style="font-size: 11.67px;">hive</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/jvm/" style="font-size: 10px;">jvm</a> <a href="/tags/kafka/" style="font-size: 10px;">kafka</a> <a href="/tags/kerberos/" style="font-size: 13.33px;">kerberos</a> <a href="/tags/lambda/" style="font-size: 10px;">lambda</a> <a href="/tags/linux/" style="font-size: 16.67px;">linux</a> <a href="/tags/log/" style="font-size: 10px;">log</a> <a href="/tags/lzo/" style="font-size: 10px;">lzo</a> <a href="/tags/mac/" style="font-size: 10px;">mac</a> <a href="/tags/ntp/" style="font-size: 10px;">ntp</a> <a href="/tags/quartz/" style="font-size: 10px;">quartz</a> <a href="/tags/queue/" style="font-size: 10px;">queue</a> <a href="/tags/scala/" style="font-size: 13.33px;">scala</a> <a href="/tags/sed/" style="font-size: 10px;">sed</a> <a href="/tags/sentry/" style="font-size: 10px;">sentry</a> <a href="/tags/shell/" style="font-size: 18.33px;">shell</a> <a href="/tags/spark/" style="font-size: 13.33px;">spark</a> <a href="/tags/sql/" style="font-size: 10px;">sql</a> <a href="/tags/vim/" style="font-size: 11.67px;">vim</a> <a href="/tags/yarn/" style="font-size: 10px;">yarn</a> <a href="/tags/任务调度/" style="font-size: 10px;">任务调度</a> <a href="/tags/多线程/" style="font-size: 10px;">多线程</a> <a href="/tags/调度/" style="font-size: 10px;">调度</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">五月 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">三月 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">二月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">一月 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">十二月 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">十一月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">八月 2015</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">六月 2015</a><span class="archive-list-count">5</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">近期文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/05/24/2016-05-24-upgrade-cdh-to-5-7-0/">升级CDH到5.7.0</a>
          </li>
        
          <li>
            <a href="/2016/05/11/2016-05-11-elasticsearch-reindex/">elasticsearch修改mapping重建索引</a>
          </li>
        
          <li>
            <a href="/2016/05/10/2016-05-10-hadoop-management/">hadoop集群管理</a>
          </li>
        
          <li>
            <a href="/2016/05/04/2016-05-04-azkaban-how-to-install-and-use/">azkaban的安装和使用</a>
          </li>
        
          <li>
            <a href="/2016/04/14/2016-04-14-quartz-in-practice/">quartz in practice</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">友情链接</h3>
    <div class="widget">
      <ul>
        
      </ul>
    </div>
  </div>

  
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 wzktravel<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
      .
      Theme by <a href="https://github.com/xiangming/landscape-plus" target="_blank">Landscape-plus</a>
    </div>
  </div>
</footer>
  </div>
  <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
  <!-- totop start -->
<div id="totop">
<a title="返回顶部"><img src="/img/scrollup.png"/></a>
</div>

<!-- totop end -->

<!-- 多说公共js代码 start -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"wzktravel"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>
<!-- 多说公共js代码 end -->


<!-- 百度分享 start -->

<!-- 百度分享 end -->

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/script.js"></script>

</div>
</body>
</html>
